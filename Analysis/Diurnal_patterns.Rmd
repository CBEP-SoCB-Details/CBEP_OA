---
title: "Diurnal Fluctuations in pH, CO~2~ and Corrected CO~2~"
output: html_notebook
---
# Introduction
This notbook seaks to document diurnal patterns in pH, pCO~2~ and temperature-corrected pCO~2~. The approach is to look at 24 hour patterns of deviations from daily averages. 

# Load Libraries
```{r}
library(tidyverse)
library(mgcv)
#library(nlme)
#library(zoo)
#library(xts)
#library(tseries)
#library(forecast)

library(CBEPgraphics)
```

# Load Data
## Establish Folder References
```{r}
sibfldnm <- 'Derived Data'
parent   <- dirname(getwd())
sibling  <- file.path(parent,sibfldnm)

fn    <- 'CascoBayOAData.csv'
fpath <- file.path(sibling,fn)
```
## Initiailze fonts
```{r}
load_cbep_fonts()
```

## Load Data
```{r} 
all_data <- read_csv(fpath,
                     col_types = cols(dd = col_integer(), 
                                      doy = col_integer(),
                                      hh = col_integer(),
                                      mm = col_integer(),
                                      yyyy = col_integer())) %>%
  select(c(13, 1:4, 14, 5:6, 8, 7 ,16, 9:12)) %>%
  mutate(yyyymmdd = paste0(yyyy,mm,dd))
```


# Diurnal Deviations
We calcuate hourly deviations from daily averages.  This can be done explicitly using linear models and extracting residuals, but the code is cleaner using the Tidyverse.

```{r}
new_data <- all_data %>%
  mutate(month = factor(mm, levels = 1:12, labels=month.abb)) %>%
  group_by(yyyy, mm, dd) %>%
  
  # Calculate sample sizes for each daay.
  mutate(co2_n      = sum(! is.na(co2)),
         co2_corr_n = sum(! is.na(co2_corr)),
         ph_n       = sum(! is.na(ph))) %>%
  
  # Calculate centered but not scaled values, day by day.
  mutate(co2_res      = scale(co2, scale = FALSE),
         co2_corr_res = scale(co2_corr, scale = FALSE),
         ph_res       = scale(ph, scale = FALSE)) %>%
  ungroup(yyyy, mm, dd) %>%
  
  # Replace data from any days with less than 20 hours of data with NA
  mutate(co2_res      = ifelse(co2_n>=20, co2_res, NA),
         co2_corr_res = ifelse(co2_corr_n>=20, co2_corr_res, NA),
         ph_res       = ifelse(ph_n>=20, ph_res, NA)) %>%
  
  # Delete the daily sample size variable
  select(-contains("_n"))
  
```

# Plot Daily pCO2 Deviations By Month
By using ggplot's geom_smooth(), we can look graphically at GAM models by month.

##  Plotting curvs against scatter plots
```{r}
plt <- ggplot(new_data, aes(hh, co2_corr_res)) + geom_jitter(alpha=0.05) +
  geom_smooth(aes(color = factor(mm)), method = mgcv::gam,
              formula = y~s(x, bs='cc'), se=FALSE)
plt
```

# Combined Graphic
Lets combine those into faceted graphs.  To do so we first must reorganize the data into "long" format.
```{r}
long_data <- new_data %>% select(-c(7:15)) %>%
  pivot_longer(contains("_res"), names_to='metric') %>%
  mutate(metric= sub("_res", "", metric))
```

```{r}
lbs <- c('pCO2', 'pH')
names(lbs) <- unique(long_data$metric)[2:3]
plt <-
  long_data %>% filter( ! metric == 'co2') %>%
  ggplot(aes(hh,value, color = month)) +
  geom_smooth(aes(color = month), method = "gam",
              formula = y~s(x, bs='cc'), se=FALSE) +

  theme_cbep() +
  xlab('Hour') +
  ylab(expression (pCO[2]~Deviations)) +
  facet_wrap(~metric, nrow=1, scales='free_y',
                   labeller = labeller(metric=lbs)) +
  scale_color_discrete(name = "Month") + 
  scale_x_continuous(breaks = c(0,6,12,18,24)) +
  ggtitle('Deviation from Daily Mean')
plt
```
Daily fluctuations are at their peak in the late summer and early fall, with highest pC02 observed in the morning, soon after sunrise. Lowest values are a few hours after sunset.  By mid-winter, the fluctuations are smaller, with peaks later in the day, around sunset, which suggests CO2 is being released all day long, and reabsorbed at night, which I don't quite understand.

# Corrected pCO2 Graph
```{r, fig.width 5, fig.height = 4, warning=FALSE}
plt <- new_data %>%
  ggplot(aes(hh,co2_corr_res, color = month)) +
  geom_smooth(aes(color=month, lty=month), method = "gam",
              formula = y~s(x, bs='cc'), se=FALSE, lwd=0.75) +
  annotate(geom = "text", label = expression(atop("Temperature", "Corrected"~pCO[2])),
           x = 24, y = 30,
           color = "black", hjust=1, size = 4) +
  theme_cbep(base_size = 12) +
  xlab('Hour') +
  ylab(expression (pCO[2]~Deviation ~(mu*Atm))) +
  scale_color_discrete(name = "Month") + 
  scale_linetype_discrete(name = "Month") + 
  theme(legend.key.width = unit(0.25,"in"),
        legend.text      = element_text(size = 10)
        ) +
  scale_x_continuous(breaks = c(0,6,12,18,24)) #+
  #ggtitle(expression(Daily~pCO[2]))
plt
ggsave('dailyCO2bymonth.pdf', device=cairo_pdf, width = 5, height = 4)
```

# Corrected pH Graph

```{r, fig.width 3, fig.height = 3, warning=FALSE}
plt <- new_data %>%
  ggplot(aes(hh,ph_res, color = month)) +
  geom_smooth(aes(color=month, lty=month), method = "gam",
              formula = y~s(x, bs='cc'), se=FALSE) +
  theme_cbep(base_size = 12) +
  theme(legend.key.width = unit(0.25,"in"),
        legend.text      = element_text(size = 10)
        ) +
  xlab('Hour') +
  ylab('pH Deviation') +
  scale_color_discrete(name = "Month") + 
  scale_linetype_discrete(name = "Month") + 
  theme(legend.key.width=unit(0.5,"in")) +
  scale_x_continuous(breaks = c(0,6,12,18,24)) #+
  #ggtitle(expression(Daily~pH))
plt
ggsave('dailyphbymonth.pdf', device=cairo_pdf, width = 5, height = 4)
```

# Formal Hypothesis Tests
WE wuld like to document formal differences between 
We do that with GAMS, formally fitting dfferent smothers by month, as folows




