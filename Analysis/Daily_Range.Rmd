---
title: "Diurnal Range of pCO~2~ by Season, in Casco Bay Maine"
output: html_notebook
---

# Introduction
This R Notebook develops models for analyzing pH and pCO~2~.

## Proposed Model
Here we look ONLY at temporal patterns of the various variables.  We are only slightly interested (for now) in the details.

So, first step is to extract data in novel forms by the day, so we can look at daily medians and daily ranges, IQRs and 80% ranges.
needs.

Once data is extracted in that form, we want to model :
1.  Parameter values
2.  Daily ranges

In terms of time of year. We assume values are autocorrlated.  WE can exaine relationshiips with day of the year, dmonth, or season, and see how much detai lwe need.

# Load Libraries
```{r}
library(tidyverse)
library(readxl)


library(nlme)      # includes gls function
#library(zoo)       # assists with time series calculations 
#library(lubridate) # simplifies management of date and time objects

library(mgcv)      # One of two common libraries for general additive models.
                   # Function gamm allows autocorrelation.
                   # plot allows examination of GAM fit components
#library(gamm4)     # A faster (?) version of gamm from mgcv, relying on lme4
                   # Fails in this use setting because if does not allow
                   # Correlation structures.
#library(ff)        # Handles large data frames more efficiently with memory


library(emmeans)   # Provides tools for calculating marginal means
library(ggeffects) # provides access functions to emmeans that return tidy tibbles and facilitate plots

library(broom)     # Allows ready conversion to tidy tibbles

library(GGally)    # For useful Pairs plot

library(CBEPgraphics)
```

# Load Data
## Establish Folder References
```{r}
sibfldnm <- 'Derived Data'
parent   <- dirname(getwd())
sibling  <- file.path(parent,sibfldnm)

fn    <- 'CascoBayOAData.csv'
fpath <- file.path(sibling,fn)
```
## Initiailze fonts
```{r}
load_cbep_fonts()
```

## Load Data
The following loads existing data, including a "Temperature Adjusted" pCO2 value based on Takehashi et al. 2002. It then collapses that data to daily summaries. 

```{r} 
all_data <- read_csv(fpath,
                     col_types = cols(dd = col_integer(), 
                                      doy = col_integer(),
                                      hh = col_integer(),
                                      mm = col_integer(),
                                      yyyy = col_integer())) %>%
  select(c(13, 1:4, 14, 5:6, 8, 7 ,16, 9:12)) %>%
  mutate(yyyymmdd = paste0(yyyy,mm,dd))

daily_data <- all_data %>%
  select(-hh, -yyyy, -mm, -dd, -doy) %>%         # Will recalculte these 
  mutate(the_date = as.Date(datetime)) %>%
  select(-datetime) %>%
  group_by(the_date) %>%
  summarise_at(c("temp", "sal", "co2", "co2_corr", "do", "ph"),
               c(m    = function(x) median(x, na.rm=TRUE),
                 r    = function(x) {suppressWarnings(max(x, na.rm=TRUE) -
                                                        min(x, na.rm=TRUE))},
                iqr  = function(x) IQR(x, na.rm=TRUE),
                p80r = function(x) {as.numeric(quantile(x, 0.90, na.rm=TRUE) -
                       quantile(x, 0.10, na.rm=TRUE))})) %>%
  mutate(yyyy = as.numeric(format(the_date, format = '%Y')),
         mm   = as.numeric(format(the_date, format = '%m')),
         dd   = as.numeric(format(the_date, format = '%d')),
         doy  = as.numeric(format(the_date, format = '%j')),
         Month = factor(mm, levels=1:12, labels = month.abb)
         )
```


# Preliminary Graphic
```{r}
plt <- daily_data %>%
  select_at(vars(contains('co2_corr'), dd, doy, mm, Month, yyyy)) %>%
  filter(! is.na(co2_corr_r) & ! is.na(Month)) %>%

  ggplot(aes(x=Month)) +
  geom_boxplot(aes(y= co2_corr_r), fill = 'lightblue') +
  xlab('Month') + 
  ylab("Daily Range of pCO2, (uAtm)") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90))
plt
#ggsave('boxplot.pdf', device=cairo_pdf)
```
```{r}
# compute lower and upper whiskers
ylim1 = boxplot.stats(daily_data$co2_corr_r)$stats[c(1, 5)]

# scale y limits based on ylim1
plt + coord_cartesian(ylim = ylim1*1.05)
```


```{r}
plt <- daily_data %>%
  select_at(vars(contains('co2_corr'), dd, doy, mm, Month, yyyy)) %>%
  filter(! is.na(co2_corr_r) & ! is.na(Month)) %>%

  ggplot(aes(x=Month, y=co2_corr_r)) +
  geom_dotplot(binwidth = 20, binaxis= 'y', stackdir = 'center',dotsize = .25,
               pch=1, color = cbep_colors()[1]) +
  xlab('Month') + 
  ylab("Daily Range of pCO2, (uAtm)") +
  theme_minimal() +
  theme_cbep() +
  theme(axis.text.x=element_text(angle=90, vjust = .3))
plt
```


```{r}
plt <- daily_data %>%
  select_at(vars(contains('CO2'), WaterBody, dd, doy, mm, Month, yyyy)) %>%
  filter(! is.na(CO2_r) & ! is.na(Month)) %>%
    filter(CO2_n >= 20) %>%                                # Drop any "short" days
  ggplot(aes(x=doy, y = CO2_r)) +
  geom_point() + 
  geom_smooth(method = 'gam', formula = y~s(x,bs='cc', k=5), se = FALSE) +
  xlab('Day of the Year') + 
  ylab("Diurnal Range of pCO2, (uAtm)") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90)) +
  facet_wrap(~WaterBody, ncol=3)
plt
ggsave('points.pdf', device=cairo_pdf)
```
# Diurnal Range by Temperature and Month
```{r}
tmp <- daily_data %>%
  select(WaterBody, Temp_m, DO_m, CO2_n, CO2_m, CO2_r, dd, doy, mm, yyyy) %>%
  mutate(Month = factor(mm, levels = 1:12, labels = month.abb)) %>%
  filter(! is.na(CO2_r), CO2_n >= 20)

plt <- ggplot(tmp, aes(Temp_m, CO2_r)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = 'gam', formula = y~s(x, bs='tp'), se = FALSE) +
  ylab("Diurnal Range of pCO2, (uAtm)") + 
  xlab('Daily Median Temperature (C)') +
  facet_wrap(~WaterBody, ncol=3) +
  theme_minimal() +
  theme(panel.spacing = unit(1, "lines"))
plt

```
